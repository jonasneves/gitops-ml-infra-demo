name: ğŸ”§ Debug SSH Access

on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Enable tmate debugging session'
        required: false
        default: true
      setup_minikube:
        type: boolean
        description: 'Setup Minikube cluster'
        required: false
        default: true
      setup_docker:
        type: boolean
        description: 'Build and run Docker container'
        required: false
        default: false

jobs:
  debug:
    name: ğŸ› Debug Environment
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx (if requested)
        if: ${{ inputs.setup_docker }}
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to GitHub Container Registry (if requested)
        if: ${{ inputs.setup_docker }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Build ML inference image (if requested)
        if: ${{ inputs.setup_docker }}
        uses: docker/build-push-action@v5
        with:
          context: ./app/ml-inference
          load: true
          tags: ml-inference:debug
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸš€ Run container locally (if requested)
        if: ${{ inputs.setup_docker }}
        run: |
          echo "Starting ML inference container..."
          docker run -d \
            --name ml-inference \
            -p 8000:8000 \
            ml-inference:debug

          echo "Waiting for container to be ready..."
          sleep 5

          echo "Container status:"
          docker ps

          echo -e "\nContainer logs:"
          docker logs ml-inference

          echo -e "\nTesting health endpoint:"
          curl -f http://localhost:8000/health || echo "Health check failed"

      - name: â˜¸ï¸ Setup Minikube (if requested)
        if: ${{ inputs.setup_minikube }}
        uses: medyagh/setup-minikube@latest
        with:
          driver: docker
          cpus: 2
          memory: 4096
          addons: metrics-server,ingress

      - name: ğŸ” Show environment info
        run: |
          echo "=== System Info ==="
          uname -a
          echo -e "\n=== Docker Info ==="
          docker --version
          docker ps -a

          if [ "${{ inputs.setup_minikube }}" == "true" ]; then
            echo -e "\n=== Kubernetes Info ==="
            kubectl version
            kubectl cluster-info
            kubectl get nodes -o wide
            kubectl get pods -A
          fi

          echo -e "\n=== Disk Usage ==="
          df -h

          echo -e "\n=== Memory Usage ==="
          free -h

          echo -e "\n=== Running Processes ==="
          ps aux | head -20

          echo -e "\n=== Network Info ==="
          ip addr show || ifconfig

      - name: ğŸ”§ Setup tmate session
        if: ${{ inputs.debug_enabled }}
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 20
        with:
          detached: false
          limit-access-to-actor: true

      - name: âœ… Debug session complete
        run: |
          echo "Debug session completed!"
          echo "To continue the workflow, create a file named 'continue':"
          echo "  touch continue"
