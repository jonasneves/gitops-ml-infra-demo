name: Live Server

run-name: "Live Server - Full GitOps Demo"

on:
  push:
    branches: [main]
    paths:
      - 'app/ml-inference/**'
      - 'k8s/**'
      - 'scripts/dashboard_server.py'
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'How long to run (max 5.5 hours)'
        required: false
        default: '5.5'
      auto_restart:
        description: 'Auto-restart before timeout'
        required: false
        default: 'true'
        type: boolean
      base_domain:
        description: 'Base domain for services (e.g., example.com)'
        required: false
        default: ''
  repository_dispatch:
    types: [restart-live-server]

concurrency:
  group: live-server
  cancel-in-progress: true

permissions:
  contents: read
  actions: write
  packages: read

jobs:
  # Orchestrator: Call component workflows in parallel
  host:
    uses: ./.github/workflows/live-host.yml
    with:
      duration_hours: ${{ inputs.duration_hours || '5.5' }}
      auto_restart: ${{ inputs.auto_restart == 'true' || inputs.auto_restart == true }}
      base_domain: ${{ inputs.base_domain || '' }}
    secrets: inherit

  monitoring:
    uses: ./.github/workflows/live-monitoring.yml
    with:
      duration_hours: ${{ inputs.duration_hours || '5.5' }}
      base_domain: ${{ inputs.base_domain || '' }}
    secrets: inherit

  notify:
    needs: [host, monitoring]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Session ended
        run: |
          echo "Host: ${{ needs.host.result }}"
          echo "Monitoring: ${{ needs.monitoring.result }}"
