name: üåê Cloudflare Tunnel Demo

on:
  workflow_dispatch:
    inputs:
      service_type:
        description: 'Service to expose'
        required: false
        default: 'ml-inference'
        type: choice
        options:
          - ml-inference
          - static-web
          - both
      tunnel_duration:
        description: 'Keep tunnel open (minutes)'
        required: false
        default: '15'
        type: string

jobs:
  cloudflare-tunnel:
    name: üöá Expose Service via Cloudflare Tunnel
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    permissions:
      contents: read
      packages: write

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Setup Docker (if ML service requested)
        if: ${{ inputs.service_type == 'ml-inference' || inputs.service_type == 'both' }}
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to GHCR (if ML service requested)
        if: ${{ inputs.service_type == 'ml-inference' || inputs.service_type == 'both' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üèóÔ∏è Build ML inference container (if requested)
        if: ${{ inputs.service_type == 'ml-inference' || inputs.service_type == 'both' }}
        uses: docker/build-push-action@v5
        with:
          context: ./app/ml-inference
          load: true
          tags: ml-inference:demo
          cache-from: type=gha

      - name: üöÄ Start ML inference service (if requested)
        if: ${{ inputs.service_type == 'ml-inference' || inputs.service_type == 'both' }}
        run: |
          echo "Starting ML inference container..."
          docker run -d \
            --name ml-inference \
            -p 8000:8000 \
            ml-inference:demo

          echo "Waiting for service to be ready..."
          sleep 5

          echo "‚úÖ ML inference service started"
          docker ps

          echo -e "\nTesting health endpoint locally:"
          curl -f http://localhost:8000/health || echo "Not ready yet"

      - name: üìÑ Create static demo page (if requested)
        if: ${{ inputs.service_type == 'static-web' || inputs.service_type == 'both' }}
        run: |
          mkdir -p /tmp/demo-site
          cat > /tmp/demo-site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>GitOps ML Infrastructure Demo</title>
              <style>
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      max-width: 1200px;
                      margin: 0 auto;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                  }
                  .container {
                      background: rgba(255, 255, 255, 0.1);
                      border-radius: 10px;
                      padding: 30px;
                      backdrop-filter: blur(10px);
                  }
                  h1 {
                      text-align: center;
                      font-size: 2.5em;
                      margin-bottom: 10px;
                  }
                  .subtitle {
                      text-align: center;
                      font-size: 1.2em;
                      opacity: 0.9;
                      margin-bottom: 30px;
                  }
                  .info-box {
                      background: rgba(255, 255, 255, 0.2);
                      border-radius: 8px;
                      padding: 20px;
                      margin: 20px 0;
                  }
                  .api-test {
                      background: rgba(0, 0, 0, 0.3);
                      border-radius: 8px;
                      padding: 20px;
                      margin: 20px 0;
                  }
                  button {
                      background: #4CAF50;
                      color: white;
                      border: none;
                      padding: 12px 24px;
                      border-radius: 5px;
                      cursor: pointer;
                      font-size: 16px;
                      margin: 5px;
                  }
                  button:hover {
                      background: #45a049;
                  }
                  #result {
                      background: rgba(0, 0, 0, 0.5);
                      padding: 15px;
                      border-radius: 5px;
                      margin-top: 15px;
                      font-family: monospace;
                      white-space: pre-wrap;
                      word-wrap: break-word;
                  }
                  .badge {
                      display: inline-block;
                      background: rgba(255, 255, 255, 0.3);
                      padding: 5px 15px;
                      border-radius: 20px;
                      margin: 5px;
                      font-size: 0.9em;
                  }
                  a {
                      color: #ffd700;
                      text-decoration: none;
                  }
                  a:hover {
                      text-decoration: underline;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üöÄ GitOps ML Infrastructure Demo</h1>
                  <p class="subtitle">Running live on GitHub Actions via Cloudflare Tunnel!</p>

                  <div class="info-box">
                      <h2>‚ú® About This Demo</h2>
                      <p>This page is served from a <strong>GitHub Actions runner</strong> and exposed to the internet via <strong>Cloudflare Tunnel</strong>.</p>
                      <div>
                          <span class="badge">üê≥ Docker</span>
                          <span class="badge">‚ò∏Ô∏è Kubernetes</span>
                          <span class="badge">üîÑ ArgoCD</span>
                          <span class="badge">üìä Prometheus</span>
                          <span class="badge">üåê Cloudflare</span>
                      </div>
                  </div>

                  <div class="info-box">
                      <h2>üéØ What's Running?</h2>
                      <ul>
                          <li><strong>ML Inference API:</strong> FastAPI service with sentiment analysis</li>
                          <li><strong>GitOps Demo:</strong> Complete CI/CD pipeline with ArgoCD</li>
                          <li><strong>Observability:</strong> Prometheus metrics & Grafana dashboards</li>
                          <li><strong>Zero Cost:</strong> Runs entirely in GitHub Actions free tier</li>
                      </ul>
                  </div>

                  <div class="api-test">
                      <h2>üß™ Test the ML API</h2>
                      <p>Try the sentiment analysis endpoint:</p>

                      <button onclick="testHealth()">üè• Health Check</button>
                      <button onclick="testPredict()">ü§ñ Test Prediction</button>
                      <button onclick="testBatch()">üì¶ Batch Prediction</button>
                      <button onclick="testMetrics()">üìä View Metrics</button>

                      <div id="result"></div>
                  </div>

                  <div class="info-box">
                      <h2>üìö Resources</h2>
                      <ul>
                          <li><a href="https://github.com/jonasneves/gitops-ml-infra-demo" target="_blank">üìÇ GitHub Repository</a></li>
                          <li><a href="http://localhost:8000/docs" id="api-docs">üìñ API Documentation (Swagger)</a></li>
                          <li><a href="http://localhost:8000/metrics" id="metrics-link">üìà Prometheus Metrics</a></li>
                      </ul>
                  </div>
              </div>

              <script>
                  // Update links with current hostname
                  const currentUrl = window.location.origin;
                  document.getElementById('api-docs').href = currentUrl + '/docs';
                  document.getElementById('metrics-link').href = currentUrl + '/metrics';

                  function showResult(data) {
                      document.getElementById('result').textContent = JSON.stringify(data, null, 2);
                  }

                  function showError(error) {
                      document.getElementById('result').textContent = 'Error: ' + error;
                  }

                  async function testHealth() {
                      try {
                          const response = await fetch('/health');
                          const data = await response.json();
                          showResult(data);
                      } catch (error) {
                          showError(error.message);
                      }
                  }

                  async function testPredict() {
                      try {
                          const response = await fetch('/predict', {
                              method: 'POST',
                              headers: {'Content-Type': 'application/json'},
                              body: JSON.stringify({text: 'This GitOps demo is amazing!'})
                          });
                          const data = await response.json();
                          showResult(data);
                      } catch (error) {
                          showError(error.message);
                      }
                  }

                  async function testBatch() {
                      try {
                          const response = await fetch('/predict/batch', {
                              method: 'POST',
                              headers: {'Content-Type': 'application/json'},
                              body: JSON.stringify({
                                  texts: ['Great work!', 'This is terrible', 'Just okay']
                              })
                          });
                          const data = await response.json();
                          showResult(data);
                      } catch (error) {
                          showError(error.message);
                      }
                  }

                  async function testMetrics() {
                      try {
                          const response = await fetch('/metrics');
                          const data = await response.text();
                          const filtered = data.split('\n')
                              .filter(line => line.startsWith('inference_'))
                              .slice(0, 20)
                              .join('\n');
                          document.getElementById('result').textContent = filtered;
                      } catch (error) {
                          showError(error.message);
                      }
                  }
              </script>
          </body>
          </html>
          EOF

          echo "‚úÖ Demo site created at /tmp/demo-site/"
          ls -la /tmp/demo-site/

      - name: üåê Start web server (if static requested)
        if: ${{ inputs.service_type == 'static-web' || inputs.service_type == 'both' }}
        run: |
          echo "Starting web server on port 8080..."
          cd /tmp/demo-site
          python3 -m http.server 8080 > /tmp/webserver.log 2>&1 &

          echo "Waiting for server to start..."
          sleep 2

          echo "‚úÖ Web server started"
          curl -f http://localhost:8080/ | head -20 || echo "Server starting..."

      - name: üöá Install Cloudflare Tunnel
        run: |
          echo "Downloading cloudflared..."
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

          echo "‚úÖ Cloudflared installed"
          cloudflared version

      - name: üåç Start Cloudflare Tunnels
        run: |
          echo "================================================"
          echo "üåê Starting Cloudflare Tunnel(s)..."
          echo "================================================"

          # Determine which services to tunnel
          SERVICE_TYPE="${{ inputs.service_type }}"
          DURATION="${{ inputs.tunnel_duration }}"

          if [ "$SERVICE_TYPE" == "ml-inference" ]; then
            echo -e "\nü§ñ Creating tunnel for ML Inference API (port 8000)..."
            cloudflared tunnel --url http://localhost:8000 > /tmp/cf-ml.log 2>&1 &
            CF_ML_PID=$!
            sleep 5

            echo -e "\nüìã ML Inference API Public URL:"
            grep -o 'https://[^ ]*\.trycloudflare.com' /tmp/cf-ml.log | head -1 || echo "Waiting for tunnel..."

          elif [ "$SERVICE_TYPE" == "static-web" ]; then
            echo -e "\nüìÑ Creating tunnel for Static Web (port 8080)..."
            cloudflared tunnel --url http://localhost:8080 > /tmp/cf-web.log 2>&1 &
            CF_WEB_PID=$!
            sleep 5

            echo -e "\nüìã Static Web Public URL:"
            grep -o 'https://[^ ]*\.trycloudflare.com' /tmp/cf-web.log | head -1 || echo "Waiting for tunnel..."

          else
            echo -e "\nü§ñ Creating tunnel for ML Inference API (port 8000)..."
            cloudflared tunnel --url http://localhost:8000 > /tmp/cf-ml.log 2>&1 &
            CF_ML_PID=$!

            echo -e "\nüìÑ Creating tunnel for Static Web (port 8080)..."
            cloudflared tunnel --url http://localhost:8080 > /tmp/cf-web.log 2>&1 &
            CF_WEB_PID=$!

            sleep 8

            echo -e "\n================================================"
            echo "üìã PUBLIC URLS - Share these links:"
            echo "================================================"
            echo -e "\nü§ñ ML Inference API:"
            grep -o 'https://[^ ]*\.trycloudflare.com' /tmp/cf-ml.log | head -1 || echo "   Waiting for tunnel..."

            echo -e "\nüìÑ Demo Website:"
            grep -o 'https://[^ ]*\.trycloudflare.com' /tmp/cf-web.log | head -1 || echo "   Waiting for tunnel..."
            echo "================================================"
          fi

          echo -e "\n‚è∞ Keeping tunnels open for ${DURATION} minutes..."
          echo "   (Workflow will timeout after 30 minutes max)"

          # Keep tunnels alive
          sleep $(( DURATION * 60 ))

      - name: üìä Show tunnel logs
        if: always()
        run: |
          echo "=== ML Inference Tunnel Log ==="
          [ -f /tmp/cf-ml.log ] && cat /tmp/cf-ml.log || echo "No ML tunnel log"

          echo -e "\n=== Web Server Tunnel Log ==="
          [ -f /tmp/cf-web.log ] && cat /tmp/cf-web.log || echo "No web tunnel log"

          echo -e "\n=== Web Server Access Log ==="
          [ -f /tmp/webserver.log ] && tail -50 /tmp/webserver.log || echo "No webserver log"

      - name: ‚úÖ Cleanup
        if: always()
        run: |
          echo "Stopping services..."
          docker stop ml-inference 2>/dev/null || true
          pkill -f "python3 -m http.server" || true
          pkill cloudflared || true
          echo "‚úÖ Cleanup complete"
