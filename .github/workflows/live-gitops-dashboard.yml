name: üé≠ Live GitOps Dashboard

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Keep dashboard open (minutes)'
        required: false
        default: '20'
        type: string

jobs:
  live-dashboard:
    name: üé¨ GitOps Theater Mode
    runs-on: ubuntu-22.04
    timeout-minutes: 35

    permissions:
      contents: read
      packages: write

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install Python dependencies
        run: |
          pip install flask flask-cors
          echo "‚úÖ Python dependencies installed"

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üèóÔ∏è Build ML inference image
        uses: docker/build-push-action@v5
        with:
          context: ./app/ml-inference
          load: true
          tags: ml-inference:live-demo
          cache-from: type=gha
          push: false

      - name: ‚ò∏Ô∏è Start Minikube cluster
        uses: medyagh/setup-minikube@latest
        with:
          driver: docker
          cpus: 2
          memory: 4096
          addons: metrics-server,ingress

      - name: üîç Verify cluster
        run: |
          echo "=== Cluster Ready ==="
          kubectl cluster-info
          kubectl get nodes
          echo "‚úÖ Cluster is ready"

      - name: üê≥ Load Docker image into Minikube
        run: |
          echo "Loading ML inference image into Minikube..."
          minikube image load ml-inference:live-demo

          # Tag it as the GHCR image name for deployment
          docker tag ml-inference:live-demo ghcr.io/${{ github.repository_owner }}/ml-inference:latest
          minikube image load ghcr.io/${{ github.repository_owner }}/ml-inference:latest

          echo "‚úÖ Image loaded into Minikube"
          minikube image ls | grep ml-inference

      - name: üì¶ Install ArgoCD
        run: |
          echo "Installing ArgoCD..."
          kubectl create namespace argocd
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.9.3/manifests/install.yaml

          echo "Waiting for ArgoCD to be ready..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=300s

          echo "‚úÖ ArgoCD installed"

      - name: üîë Setup ArgoCD
        run: |
          sleep 10
          ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo "::add-mask::$ARGOCD_PASSWORD"
          echo "ARGOCD_PASSWORD=$ARGOCD_PASSWORD" >> $GITHUB_ENV

          # Install ArgoCD CLI
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/download/v2.9.3/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

          # Port forward ArgoCD
          kubectl port-forward svc/argocd-server -n argocd 8081:443 > /dev/null 2>&1 &
          sleep 5

          # Login to ArgoCD
          argocd login localhost:8081 --username admin --password $ARGOCD_PASSWORD --insecure

          # Register repository
          argocd repo add https://github.com/${{ github.repository }}.git \
            --username ${{ github.actor }} \
            --password ${{ secrets.GITHUB_TOKEN }} \
            --insecure-skip-server-verification \
            --upsert

          echo "‚úÖ ArgoCD configured"

      - name: üé® Setup dashboard server
        run: |
          cp scripts/dashboard_server.py /tmp/dashboard_server.py
          echo "‚úÖ Dashboard server ready"

      - name: üé¨ Start deployment and dashboard
        run: |
          # Start dashboard server in background
          cd /tmp
          python3 dashboard_server.py > /tmp/dashboard.log 2>&1 &
          DASHBOARD_PID=$!
          echo "Dashboard PID: $DASHBOARD_PID"

          sleep 3

          # Test dashboard is running
          curl -f http://localhost:8080/ > /dev/null || {
            echo "Dashboard failed to start!"
            cat /tmp/dashboard.log
            exit 1
          }

          echo "‚úÖ Dashboard server started on port 8080"

      - name: üöÄ Deploy applications via ArgoCD
        run: |
          echo "Creating namespaces..."
          kubectl create namespace ml-inference || true
          kubectl create namespace monitoring || true

          echo "Creating ArgoCD applications..."

          # Create ML Inference app
          argocd app create ml-inference \
            --repo https://github.com/${{ github.repository }}.git \
            --path k8s/inference-service \
            --revision ${{ github.ref_name }} \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace ml-inference \
            --sync-policy automated \
            --self-heal \
            --auto-prune \
            --sync-option CreateNamespace=true || echo "App already exists"

          # Create Observability app
          argocd app create observability \
            --repo https://github.com/${{ github.repository }}.git \
            --path k8s/observability \
            --revision ${{ github.ref_name }} \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace monitoring \
            --sync-policy automated \
            --self-heal \
            --auto-prune \
            --sync-option CreateNamespace=true || echo "App already exists"

          echo "‚úÖ Applications created - watch them sync on the dashboard!"

      - name: üöá Install Cloudflare Tunnel
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
          cloudflared version

      - name: üåç Start Cloudflare Tunnel
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          echo "================================================"
          echo "üåê Starting Cloudflare Tunnel..."
          echo "================================================"

          # Create tunnel credentials file
          mkdir -p ~/.cloudflared
          echo "$TUNNEL_TOKEN" > ~/.cloudflared/tunnel-token.json

          # Start named tunnel
          cloudflared tunnel --credentials-file ~/.cloudflared/tunnel-token.json run gitops-demo > /tmp/cf-dashboard.log 2>&1 &
          sleep 10

          echo ""
          echo "================================================"
          echo "üé≠ LIVE GITOPS DASHBOARD URL:"
          echo "================================================"
          echo "https://gitops-infra.neevs.io"
          echo "================================================"
          echo ""
          echo "‚è∞ Dashboard will remain open for ${{ inputs.duration }} minutes"
          echo "   Watch your GitOps deployment in real-time!"
          echo ""

          # Keep tunnel alive
          sleep $(( ${{ inputs.duration }} * 60 ))

      - name: üìä Show final status
        if: always()
        run: |
          echo "=== Final Deployment Status ==="
          argocd app list || true
          kubectl get all -n ml-inference || true
          kubectl get all -n monitoring || true

          echo -e "\n=== Dashboard Logs ==="
          tail -50 /tmp/dashboard.log || true

      - name: ‚úÖ Cleanup
        if: always()
        run: |
          pkill -f dashboard_server.py || true
          pkill cloudflared || true
          echo "‚úÖ Cleanup complete"
